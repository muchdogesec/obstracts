FROM python:3.11
ENV PYTHONUNBUFFERED=1

ARG DJANGO_SECRET=
ARG DJANGO_DEBUG=
ARG CELERY_BROKER_CONNECTION_RETRY_ON_STARTUP=
ARG MAX_PAGE_SIZE=
ARG DEFAULT_PAGE_SIZE=
ARG BIN_LIST_API_KEY=
ARG OPENAI_API_KEY=
ARG OPENAI_MODEL=
ARG INPUT_TOKEN_LIMIT=
ARG CTIBUTLER_HOST=
ARG CTIBUTLER_APIKEY=
ARG VULMATCH_HOST=
ARG VULMATCH_APIKEY=
ARG GOOGLE_VISION_API_KEY=
ARG USE_S3_STORAGE=
ARG R2_ENDPOINT_URL=
ARG R2_BUCKET_NAME=
ARG R2_ACCESS_KEY=
ARG R2_SECRET_KEY= 
ARG R2_CUSTOM_DOMAIN=

ENV DJANGO_SECRET=${DJANGO_SECRET}
ENV DJANGO_DEBUG=${DJANGO_DEBUG}
ENV CELERY_BROKER_CONNECTION_RETRY_ON_STARTUP=${CELERY_BROKER_CONNECTION_RETRY_ON_STARTUP}
ENV MAX_PAGE_SIZE=${MAX_PAGE_SIZE}
ENV DEFAULT_PAGE_SIZE=${DEFAULT_PAGE_SIZE}
ENV BIN_LIST_API_KEY=${BIN_LIST_API_KEY}
ENV OPENAI_API_KEY=${OPENAI_API_KEY}
ENV OPENAI_MODEL=${OPENAI_MODEL}
ENV INPUT_TOKEN_LIMIT=${INPUT_TOKEN_LIMIT}
ENV CTIBUTLER_HOST=${CTIBUTLER_HOST}
ENV CTIBUTLER_APIKEY=${CTIBUTLER_APIKEY}
ENV VULMATCH_HOST=${VULMATCH_HOST}
ENV VULMATCH_APIKEY=${VULMATCH_APIKEY}
ENV GOOGLE_VISION_API_KEY=${GOOGLE_VISION_API_KEY}
ENV USE_S3_STORAGE=${USE_S3_STORAGE}
ENV R2_ENDPOINT_URL=${R2_ENDPOINT_URL}
ENV R2_BUCKET_NAME=${R2_BUCKET_NAME}
ENV R2_ACCESS_KEY=${R2_ACCESS_KEY}
ENV R2_CUSTOM_DOMAIN=${R2_CUSTOM_DOMAIN}

WORKDIR /usr/src/app
COPY requirements.txt ./
RUN pip install -r requirements.txt

COPY . /usr/src/app
RUN pip install https://github.com/muchdogesec/dogesec_commons/releases/download/main-2024-11-01/dogesec_commons-0.0.1b0-py3-none-any.whl