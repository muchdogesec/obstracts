FROM python:3.11-slim
ENV PYTHONUNBUFFERED=1

ARG DJANGO_SECRET=
ARG DJANGO_DEBUG=
ARG BIN_LIST_API_KEY=
ARG OPENAI_API_KEY=
ARG ANTHROPIC_API_KEY=
ARG GOOGLE_API_KEY=
ARG GOOGLE_VISION_API_KEY=
ARG R2_BUCKET_NAME=
ARG R2_ACCESS_KEY=
ARG R2_SECRET_KEY= 
ARG R2_CUSTOM_DOMAIN=
ARG POSTGRES_PASSWORD=
ARG ARANGODB_PASSWORD=

ENV DJANGO_SECRET=${DJANGO_SECRET}
ENV DJANGO_DEBUG=${DJANGO_DEBUG}
ENV BIN_LIST_API_KEY=${BIN_LIST_API_KEY}
ENV OPENAI_API_KEY=${OPENAI_API_KEY}
ENV ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY} 
ENV GOOGLE_API_KEY=${GOOGLE_API_KEY}
ENV GOOGLE_VISION_API_KEY=${GOOGLE_VISION_API_KEY}
ENV R2_BUCKET_NAME=${R2_BUCKET_NAME}
ENV R2_ACCESS_KEY=${R2_ACCESS_KEY}
ENV R2_SECRET_KEY=${R2_SECRET_KEY}
ENV R2_CUSTOM_DOMAIN=${R2_CUSTOM_DOMAIN}
ENV POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
ENV ARANGODB_PASSWORD=${ARANGODB_PASSWORD}

ENV CELERY_BROKER_CONNECTION_RETRY_ON_STARTUP=1
ENV CELERY_BROKER_URL=redis://host.docker.internal:6379/3
ENV MAX_PAGE_SIZE=50
ENV DEFAULT_PAGE_SIZE=50
ENV INPUT_TOKEN_LIMIT=12500
ENV USE_S3_STORAGE=1
ENV CTIBUTLER_HOST=http://37.27.208.239:8006
ENV VULMATCH_HOST=http://37.27.208.239:8005
ENV HISTORY4FEED_URL=http://host.docker.internal:8002/
ENV ARANGODB_USERNAME=obstracts
ENV ARANGODB_HOST_URL=http://host.docker.internal:8529
ENV POSTGRES_USER=obstracts
ENV POSTGRES_DB=obstracts_database
ENV POSTGRES_HOST=host.docker.internal
ENV R2_ENDPOINT_URL=https://34fe0652772b226d5f06050bf5050738.r2.cloudflarestorage.com

WORKDIR /usr/src/app
COPY requirements.txt ./
RUN --mount=type=cache,target=/root/.cache \
    pip install -r requirements.txt

COPY . /usr/src/app